@model BattleCode.Models.BattleViewModel

@{
    ViewBag.Title = "程式對戰";
    var firstProblem = Model.Problems.FirstOrDefault();

    var totalProblems = Model.Problems.Count;
}


<!-- CodeMirror -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/python/python.min.js"></script>

<style>


    #players {
        display: flex;
        justify-content: space-between;
        margin: 30px 0;
    }

    .player-box {
        background-color: #fff;
        border: 2px solid #dcdcdc;
        padding: 20px;
        width: 48%;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        text-align: center;
        border-radius: 12px;
    }

        .player-box p {
            font-size: 24px; /* 名字與「得分：」整行變大 */
        }

        .player-box span {
            font-size: 28px; /* 分數數字再大一點 */
            font-weight: bold;
        }

    #battle-area {
        background-color: #fff;
        border: 1px solid #ddd;
        padding: 25px;
        border-radius: 10px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    }

    #problem-container p {
        margin: 5px 0;
    }

    #countdown {
        font-size: 48px;
        color: #e74c3c;
        text-align: center;
        font-weight: bold;
    }

    #progress-info {
        text-align: center;
        font-size: 18px;
        margin-bottom: 20px;
    }

    #code-editor {
        height: 400px;
    }

    #submit-code, #ai-hint-btn {
        background-color: #3498db;
        color: white;
        border: none;
        border-radius: 6px;
        padding: 12px 24px;
        margin-top: 15px;
        cursor: pointer;
        font-size: 16px;
    }

        #submit-code[disabled], ai-hint-btn[disabled] {
            background-color: #bdc3c7;
        }

        #submit-code:hover, #ai-hint-btn:hover {
            background-color: #217dbb;
        }

    #ai-hint-result {
        margin-top: 10px;
        color: #2980b9;
        font-style: italic;
    }

    #match-result {
        display: none;
        text-align: center;
        font-size: 24px;
        color: #27ae60;
        margin-top: 40px;
    }

    #ai-hint-result {
        display: none; /* 預設收起來 */
        margin-top: 10px;
        max-height: 200px;
        overflow-y: auto;
        padding: 10px;
        border: 1px solid #ccc;
        background-color: #f9f9f9;
        border-radius: 8px;
        font-size: 16px;
        white-space: pre-wrap; /* 保留換行與縮排，自動換行 */
    }

    #problem-container {
        font-size: 20px; /* 整體字體變大 */
        line-height: 1.6;
    }

        #problem-container h4 {
            font-size: 24px;
            margin-bottom: 10px;
            color: #2c3e50;
            font-weight: bold;
        }

        #problem-container p {
            font-size: 20px;
            margin: 8px 0;
        }

        #problem-container span {
            font-size: 20px;
        }
</style>


<h2>程式對戰 </h2>
<!--- 對戰編號：Model.Match.MatchId-->
<div id="countdown"></div>
<div id="progress-info">
    <strong>第 <span id="current-problem-number">1</span> 題 / 共 @Model.Problems.Count 題</strong>
</div>

<div id="players">
    <div class="player-box">
        <h4>玩家 1</h4>
        <p>@Model.Player1DisplayName</p>
        <p>得分：<span id="player1-score">@Model.Player1Score</span></p>
    </div>
    <div class="player-box">
        <h4>玩家 2</h4>
        <p>@Model.Player2DisplayName</p>
        <p>得分：<span id="player2-score">@Model.Player2Score</span></p>
    </div>
</div>

<div id="battle-area">
    <h3>題目區</h3>
    <div id="problem-container">
        @if (firstProblem != null)
        {
            <h4 id="problem-title">@firstProblem.Title</h4>
            <p id="problem-description">@firstProblem.Description</p>
            <p><strong>輸入格式：</strong> <span id="input-format">@firstProblem.InputFormat</span></p>
            <p><strong>輸出格式：</strong> <span id="output-format">@firstProblem.OutputFormat</span></p>
            <p><strong>範例輸入：</strong> <span id="sample-input">@firstProblem.SampleInputs</span></p>
            <p><strong>範例輸出：</strong> <span id="sample-output">@firstProblem.SampleOutputs</span></p>
        }
        else
        {
            <p>⚠ 無題目可顯示。</p>
        }
    </div>

    <div id="ai-hint-area">
        <button id="ai-hint-btn">AI提示</button>
        <div id="ai-hint-result"></div>
    </div>

    <h3>程式碼編輯區</h3>
    <textarea id="code-editor" placeholder="請在此撰寫程式碼" disabled></textarea>
    <br />
    <button id="submit-code" disabled>提交答案</button>

    <div id="loading" style="display:none; color:blue; margin-top:10px;">正在提交中...</div>
    <div id="submission-result" style="margin-top:10px; font-weight:bold;"></div>
</div>

<div id="match-result">🎉 對戰結束！請稍候查看戰績。</div>

<input type="hidden" id="problemId" value="@(firstProblem?.ProblemId ?? 0)" />
<input type="hidden" id="language" value="@(firstProblem?.Language ?? "python")" />
<input type="hidden" id="playerId" value="@Model.PlayerId" />

<script>

    // 初始化 CodeMirror 編輯器
    let editor = CodeMirror.fromTextArea(document.getElementById("code-editor"), {
        lineNumbers: true,
        mode: "python", // 預設先給 python
        theme: "default",
        indentUnit: 4,
        tabSize: 4,
        autofocus: true
    });

    const language = $('#language').val();

    let mode = "python"; // 預設
    if (language === "cpp") {
        mode = "text/x-c++src";
    } else if (language === "java") {
        mode = "text/x-java";
    } else if (language === "python") {
        mode = "python";
    }

    // 設定 CodeMirror 的語法高亮模式
    editor.setOption("mode", mode);

    // 讓外部控制 disabled 狀態時也能清除
    function setEditorEnabled(enabled) {
        editor.setOption("readOnly", !enabled);
    }

</script>



@section scripts {
    <script src="~/Scripts/jquery.signalR-2.4.3.min.js"></script>
    <script src="/signalr/hubs"></script>
    <script>
            $(function () {
                const matchId = '@Model.Match.MatchId';
                const totalProblems = @totalProblems;
                const language = $('#language').val();
                let problemId = $('#problemId').val();
                let timerInterval;
                let hasSubmitted = false;
                let timeUp = false;
                let currentProblemIndex = 1;
                //let hasCorrectAnswer = false;

                const connection = $.hubConnection();
                const hub = connection.createHubProxy("battleHub");

                connection.start().done(() => {
                    console.log("SignalR 已連線");
                    hub.invoke("joinMatchGroup", matchId);
                });
                // ===== AI提示 =====
                $('#ai-hint-btn').click(function () {
                    $('#ai-hint-btn').prop('disabled', true).text('載入中...');
                    //$('#ai-hint-result').text('');
                    $('#ai-hint-result').hide().text(''); // 確保點下去前先隱藏內容
                    $.get('/Match/GetAiHint', {
                        problemId: $('#problemId').val(),
                        matchId: matchId,
                        userId: $('#playerId').val()
                    }, function (res) {
                        if (res.success) {
                           // $('#ai-hint-result').text(res.hint);
                            $('#ai-hint-result').text(res.hint).show(); // 顯示提示框並塞入內容
                        } else {
                            $('#ai-hint-result').text(res.hint || '取得AI提示失敗');
                        }
                        $('#ai-hint-btn').prop('disabled', false).text('AI提示');
                    }).fail(function () {
                        $('#ai-hint-result').text('取得AI提示失敗');
                        $('#ai-hint-btn').prop('disabled', false).text('AI提示');
                    });
                });
                // 開場倒數（3→2→1→GO!）
                hub.on("startCountdown", () => {
                    let countdown = 3;
                    const countdownDiv = $("#countdown").show();
                    clearInterval(timerInterval);

                    const interval = setInterval(() => {
                        if (countdown > 0) {
                            countdownDiv.text(countdown--);
                        } else {
                            clearInterval(interval);
                            countdownDiv.text("GO!");
                            setTimeout(() => {
                                countdownDiv.hide();
                                enableCodeArea();
                                startProblemTimer(60);
                            }, 800);
                        }
                    }, 1000);
                });

                // 題目倒數計時
                function startProblemTimer(seconds) {
                    clearInterval(timerInterval);
                    let remaining = seconds;
                    const countdownDiv = $("#countdown").show();
                    timeUp = false;
                    const problemId = $('#problemId').val();
                    const language = $('#language').val();
                    countdownDiv.text("剩餘：" + remaining + " 秒");
                    const aiHint = $('#ai-hint-result').text().trim() || "";
                    timerInterval = setInterval(() => {
                        remaining--;
                        if (remaining >= 0) {
                            countdownDiv.text("剩餘：" + remaining + " 秒");
                        } else {
                            clearInterval(timerInterval);
                            timeUp = true;
                            countdownDiv.text("時間到！");
                            console.log("準備自動提交空白：", matchId, problemId, language);
                            disableCodeArea();

                            if (!hasSubmitted) {
                                $('#submission-result').html("⏰ 時間到，未作答");
                                // 通知伺服器自動提交空白
                                $.ajax({
                                    url: '/Match/SubmitCode',
                                    type: 'POST',
                                    contentType: 'application/json',
                                    data: JSON.stringify({
                                        matchId: matchId,
                                        problemId: parseInt(problemId),
                                        code: '',
                                        language: language,
                                        aiHint: aiHint
                                    }),
                                    success: function (res) {
                                        console.log("時間到自動提交成功", res);
                                        hasSubmitted = true;
                                        updateScores();
                                    },
                                    error: function (err) {
                                        console.error("時間到自動提交失敗", err);
                                        alert("提交失敗：" + err.responseText);
                                    }
                                });
                            } else {
                                $('#submission-result').html("❌ 錯誤答案");
                                $.ajax({
                                    url: '/Match/SubmitCode',
                                    type: 'POST',
                                    contentType: 'application/json',
                                    data: JSON.stringify({
                                        matchId: matchId,
                                        problemId: parseInt(problemId),
                                        code: '',
                                        language: language,
                                        aiHint: aiHint
                                    }),
                                    success: function (res) {
                                        console.log("時間到重送以切題成功", res);
                                        updateScores(); // 可選
                                    },
                                    error: function (err) {
                                        console.error("時間到重送提交失敗", err);
                                    }
                                });
                            }
                        }
                    }, 1000);
                }
                // 提交答案按鈕
                $('#submit-code').click(function () {
                    //const code = $('#code-editor').val().trim();

                    const code = editor.getValue().trim();
                    if (!code) {
                        alert("請輸入程式碼！");
                        return;
                    }
                    // 取得目前 AI 提示文字，若沒有則空字串
                    const aiHint = $('#ai-hint-result').text().trim() || "";

                    console.log("matchId: " + matchId);
                    console.log("problemId: " + problemId);
                    console.log("code: " + code);
                    console.log("language: " + language);

                    $('#loading').show();
                    $('#submission-result').text("");

                    $.ajax({
                        url: '/Match/SubmitCode',
                        type: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify({
                            matchId: matchId,
                            problemId: parseInt(problemId),
                            code: code,
                            language: language,
                            aiHint: aiHint   // 新增這行
                        }),
                        success: function (res) {
                            $('#loading').hide();
                            hasSubmitted = true;

                            if (res.success) {
                                if (res.isCorrect) {
                                    hasCorrectAnswer = true;
                                    $('#submission-result').html("✅ 答對了！<br/>" + (res.result || ''));
                                    disableCodeArea();
                                } else {
                                    $('#submission-result').html("❌ 錯誤答案<br/>" + (res.message || ''));
                                    // 答錯可以繼續送，不要 disable
                                }
                            } else {
                                $('#submission-result').html("❌ 錯誤答案<br/>" + (res.message || ''));
                            }
                            updateScores();
                        },
                        error: function () {
                            $('#loading').hide();
                            alert("提交失敗，請稍後再試！");
                        }
                    });
                });

                function updateScores() {
                    $.get('/Match/GetScores', { matchId: matchId }, function (res) {
                        if (res.success) {
                            $('#player1-score').text(res.player1Score);
                            $('#player2-score').text(res.player2Score);
                        }
                    });
                }

                // 換題
                hub.on("nextProblem", function (nextProblemId, currentIndex) {
                    currentProblemIndex = currentIndex;
                    $('#current-problem-number').text(currentProblemIndex);

                    hasSubmitted = false;

                    $('#loading').hide();
                    $('#code-editor').val("").prop('disabled', true);
                    $('#submit-code').prop('disabled', true);
                    $('#problemId').val(nextProblemId);
                    problemId = nextProblemId;

                    // 先倒數 3 秒再載題目
                    let countdown = 3;
                    const countdownDiv = $("#countdown").show();
                    clearInterval(timerInterval);

                    const interval = setInterval(() => {
                        if (countdown > 0) {
                            countdownDiv.text(countdown--);
                        } else {
                            clearInterval(interval);
                            countdownDiv.text("GO!");
                            setTimeout(() => {
                                countdownDiv.hide();
                                $('#ai-hint-result').empty().hide();///清空上一題的AI題示
                                $('#submission-result').empty();///清空
                                editor.setValue("");
                                // *** 這裡才載新題目 ***
                                $.get('/Match/GetProblemDetail', { problemId: nextProblemId }, function (res) {
                                    if (res.success) {
                                        $('#problem-title').text(res.title);
                                        $('#problem-description').text(res.description);
                                        $('#input-format').text(res.inputFormat);
                                        $('#output-format').text(res.outputFormat);
                                        $('#sample-input').text(res.sampleInput);
                                        $('#sample-output').text(res.sampleOutput);

                                        enableCodeArea();
                                        startProblemTimer(60);
                                    } else {
                                        alert("無法載入題目");
                                    }
                                });
                                updateScores();
                            }, 800);
                        }
                    }, 1000);
                });
                hub.on("matchFinished", function () {
                    clearInterval(timerInterval);
                    $('#battle-area').hide();
                    $('#match-result').show().text("🎉 對戰結束，正在載入戰績...");

                    setTimeout(() => {
                        window.location.href = '/Match/Result?matchId=' + matchId;
                    }, 1000); // 小延遲讓使用者感覺順暢
                });


                function enableCodeArea() {
                    $('#code-editor').prop('disabled', false);
                    $('#submit-code').prop('disabled', false);
                }

                function disableCodeArea() {
                    $('#code-editor').prop('disabled', true);
                    $('#submit-code').prop('disabled', true);
                }

                window.onbeforeunload = function () {
                    hub.invoke("leaveMatch", matchId);
                    connection.stop();
                };
            });
    </script>
}
